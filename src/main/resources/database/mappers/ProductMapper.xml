<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.prac.boot3.product.ProductMapper">

<select id="getList"  parameterType="Pager" resultMap="listResult">
		SELECT P.*, F.*
		FROM 
		(
			SELECT 
			* 
		 	FROM PRODUCT 
		 	WHERE PRODUCTNUM>0 and 
		 		 
			<choose>
				<when test="kind == 'col1'">
					PRODUCTNAME
				</when>
				 <when test="kind=='col2'">
                	 PRODUCTPRICE
             	</when>
             	<otherwise>
                	 PRODUCTDETAIL
             	</otherwise>
 			 </choose>
			LIKE CONCAT('%',#{search},'%')
			ORDER BY PRODUCTNUM DESC
			LIMIT #{startRow}, #{perPage} 	
		 ) P
		LEFT JOIN 
		PRODUCTFILES F
		USING (PRODUCTNUM)
</select>
  
<resultMap type="ProductVO" id="listResult">
<id column="productNum" property="productNum"/>
<result column="productCount" property="productCount"/>
<result column="productName" property="productName"/>
<result column="productPrice" property="productPrice"/>
<result column="productDetail" property="productDetail"/>
<collection property="productFilesVO" javaType="java.util.List" ofType="ProductFilesVO">
<id column="fileNum" property="fileNum"/>
<result column="fileName" property="fileName"/>
<result column="oriName" property="oriName"/>
</collection>
</resultMap>

<select id="getTotalCount" parameterType="Pager" resultType="Long">
SELECT COUNT(PRODUCTNUM) FROM PRODUCT
WHERE 
      <choose>
             <when test="kind=='col1'">
                 PRODUCTNAME
             </when>
             <when test="kind=='col2'">
                 PRODUCTPRICE
             </when>
             <otherwise>
                 PRODUCTDETAIL
             </otherwise>
          </choose>
          LIKE CONCAT('%', #{search},'%') 
</select>

<insert id="setAdd" parameterType="ProductVO" useGeneratedKeys="true" keyProperty="productNum">
INSERT INTO PRODUCT(PRODUCTNUM,PRODUCTNAME,PRODUCTPRICE,PRODUCTCOUNT,PRODUCTDETAIL)
VALUES(#{productNum},#{productName},#{productPrice},#{productCount},#{productDetail})
</insert>

 <insert id="setFileAdd" parameterType="ProductFilesVO">
INSERT INTO PRODUCTFILES(FILENUM,PRODUCTNUM,FILENAME,ORINAME)
      VALUES(NULL,#{productNum},#{fileName}, #{oriName})  
</insert>

</mapper>